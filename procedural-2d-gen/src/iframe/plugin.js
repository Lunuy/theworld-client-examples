(function () {
	'use strict';

	var Logger=function(){function n(){}return n.init=function(o){n._plugin=o;},n.log=function(o){n._plugin.broadcastMessage("log",o);},n.error=function(o){n._plugin.broadcastMessage("error",o);},n}();

	var Coroutine=function(){function t(t,e){this._elapsedTime=0,this._coroutineIterator=t,this._currentYieldInstruction=null,this._isCurrenYieldInstructionExist=!1,this._onFinish=null!=e?e:null;}return Object.defineProperty(t.prototype,"elapsedTime",{get:function(){return this._elapsedTime},set:function(t){this._elapsedTime=t;},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentYieldInstruction",{get:function(){return this._currentYieldInstruction},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentYieldInstructionExist",{get:function(){return this._isCurrenYieldInstructionExist},enumerable:!1,configurable:!0}),t.prototype.fatchNextInstruction=function(){var t,e=this._coroutineIterator.next();return e.done?(this._currentYieldInstruction=null,this._isCurrenYieldInstructionExist=!1,null===(t=this._onFinish)||void 0===t||t.call(this),this._onFinish=null,null):(this._currentYieldInstruction=e.value,this._isCurrenYieldInstructionExist=!0,this._currentYieldInstruction)},t}();

	var __extends=this&&this.__extends||function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e;}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e;}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r);}}(),YieldInstruction=function(){};var WaitForSeconds=function(t){function e(e){var n=t.call(this)||this;return n._seconds=e,n}return __extends(e,t),Object.defineProperty(e.prototype,"seconds",{get:function(){return this._seconds},enumerable:!1,configurable:!0}),e}(YieldInstruction);var WaitUntil=function(t){function e(e){var n=t.call(this)||this;return n._predicate=e,n}return __extends(e,t),Object.defineProperty(e.prototype,"predicate",{get:function(){return this._predicate},enumerable:!1,configurable:!0}),e}(YieldInstruction);var WaitWhile=function(t){function e(e){var n=t.call(this)||this;return n._predicate=e,n}return __extends(e,t),Object.defineProperty(e.prototype,"predicate",{get:function(){return this._predicate},enumerable:!1,configurable:!0}),e}(YieldInstruction);

	var CoroutineProcessor=function(){function t(t){this._time=t,this._coroutines=[],this._coroutineCount=0;}return t.prototype.addCoroutine=function(t){this._coroutines.push(t),this._coroutineCount+=1;},t.prototype.removeCoroutine=function(t){var o=this._coroutines.indexOf(t);o>=0&&(this._coroutines[o]=null,this._coroutineCount-=1);},t.prototype.tryCompact=function(){var o=this._coroutines;if(t._needToCompactCount<=o.length-this._coroutineCount){for(var n=0,e=0;e<o.length;++e){var i=o[e];null!==i&&(o[n]=i,n+=1);}o.length=this._coroutineCount;}},t.prototype.process=function(){for(var t=this._coroutines,o=0;o<t.length;++o){var n=t[o];null!==n&&(n.currentYieldInstructionExist?this.updateAfterProcessSingleInstruction(n):(t[o]=null,this._coroutineCount-=1));}},t.prototype.updateAfterProcessSingleInstruction=function(t){var o=t.currentYieldInstruction;o instanceof WaitForSeconds?(t.elapsedTime+=this._time.deltaTime,t.elapsedTime>=o.seconds&&(t.elapsedTime=0,t.fatchNextInstruction())):o instanceof WaitUntil?o.predicate()&&t.fatchNextInstruction():o instanceof WaitWhile?o.predicate()||t.fatchNextInstruction():null===o&&t.fatchNextInstruction();},t._needToCompactCount=16,t}();

	var Time=function(){function e(){this._oldTime=0,this._time=0,this._unscaledTime=0,this._deltaTime=0,this._unscaledDeltaTime=0,this._timeScale=1;}return e.prototype.start=function(){this._oldTime=Date.now();},e.prototype.update=function(){var e=Date.now(),t=(e-this._oldTime)/1e3;this._unscaledDeltaTime=t,this._unscaledTime+=t,this._deltaTime=t*this._timeScale,this._time+=this._deltaTime,this._oldTime=e;},Object.defineProperty(e.prototype,"time",{get:function(){return this._time},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"unscaledTime",{get:function(){return this._unscaledTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"deltaTime",{get:function(){return this._deltaTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"unscaledDeltaTime",{get:function(){return this._unscaledDeltaTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"timeScale",{get:function(){return this._timeScale},set:function(e){this._timeScale=e;},enumerable:!1,configurable:!0}),e}();

	var CoroutineDispatcher=function(){function o(o){void 0===o&&(o=10);var t=this;this.update=function(){t._time.update(),t._coroutineProcessor.process(),t._coroutineProcessor.tryCompact();};var r=this._time=new Time;this._coroutineProcessor=new CoroutineProcessor(r),r.start(),this._setIntervalId=setInterval((function(){try{t.update();}catch(o){Logger.error(o);}}),o);}return o.prototype.startCoroutine=function(o){var t=new Coroutine(o);return t.fatchNextInstruction(),this._coroutineProcessor.addCoroutine(t),t},o.prototype.dispose=function(){null!==this._setIntervalId&&(clearInterval(this._setIntervalId),this._setIntervalId=null);},o}();

	var Vector2=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e;}return t.prototype.freeze=function(){return Object.freeze(this)},t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.set=function(t,e){return this.x=t,this.y=e,this},t.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},t}();

	var __extends$1=this&&this.__extends||function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n;}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e]);},t(n,e)};return function(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=n;}t(n,e),n.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r);}}(),BiomePreset=function(){function t(){}return t.prototype.getTileSprite=function(t){var n=this.tiles;return n[Math.floor(t.next()*n.length)]},t.prototype.matchCondition=function(t,n,e){return t>=this.minHeight&&n>=this.minMoisture&&e>=this.minHeat},t}();var Desert=new(function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.tiles=[{i:70,a:15}],n.minHeight=0,n.minMoisture=0,n.minHeat=.9,n}return __extends$1(n,t),n}(BiomePreset));var Grassland=new(function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.tiles=[{i:70,a:22}],n.minHeight=.1,n.minMoisture=.2,n.minHeat=.1,n}return __extends$1(n,t),n}(BiomePreset));var Mountains=new(function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.tiles=[{i:70,a:54}],n.minHeight=.7,n.minMoisture=0,n.minHeat=0,n}return __extends$1(n,t),n}(BiomePreset));

	var Mulberry32=function(){function t(t){this._a=t;}return t.prototype.next=function(){var t=this._a+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296},t}();

	var Wave=function(r,e,t){this.seed=r,this.frequency=e,this.amplitude=t;};var NoiseGenerator=function(){function r(){}return r.generate=function(r,e,t,n,o){for(var i=new Array(r),a=0;a<r;a++){i[a]=new Array(e);for(var f=0;f<e;f++)i[a][f]=0;}for(a=0;a<r;++a)for(f=0;f<e;++f){for(var u=a*t+o.x,s=f*t+o.y,h=0,p=0;p<n.length;++p){var l=n[p];i[a][f]+=l.amplitude*(this.perlinNoise(u*l.frequency+l.seed,s*l.frequency+l.seed)+.5),h+=l.amplitude;}i[a][f]/=h;}return i},r.floorToInt=function(r){return r>0?Math.floor(r):Math.ceil(r)},r.fade=function(r){return r*r*r*(r*(6*r-15)+10)},r.grad=function(r,e,t){return (0==(1&r)?e:-e)+(0==(2&r)?t:-t)},r.lerp=function(r,e,t){return e+r*(t-e)},r.perlinNoise=function(e,t){var n=255&r.floorToInt(e),o=255&r.floorToInt(t);e-=Math.floor(e),t-=Math.floor(t);var i=this.fade(e),a=this.fade(t),f=r._perm[n]+o&255,u=r._perm[o+1]+o&255;return this.lerp(a,this.lerp(i,this.grad(r._perm[f],e,t),this.grad(r._perm[u],e-1,t)),this.lerp(i,this.grad(r._perm[f+1],e,t-1),this.grad(r._perm[u+1],e-1,t-1)))},r._perm=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180,151],r}();

	var BiomeTempData=function(){function e(e){this.biome=e;}return e.prototype.getDiffValue=function(e,t,r){var i=this.biome;return e-i.minHeight+(t-i.minMoisture)+(r-i.minHeat)},e}();var ProceduralMapGenerator=function(){function e(e){this.biomes=[Desert,Grassland,Mountains],this.scale=1,this.heightWaves=[new Wave(56,.05,1),new Wave(199.36,.1,.5)],this.moistureWaves=[new Wave(621,.03,1)],this.heatWaves=[new Wave(318.6,.04,1),new Wave(329.7,.02,.5)],this._mulberry=new Mulberry32(0),this.tilemap=e;}return e.prototype.generateMap=function(e,t,r){for(var i=NoiseGenerator.generate(e,t,this.scale,this.heightWaves,r),a=NoiseGenerator.generate(e,t,this.scale,this.moistureWaves,r),o=NoiseGenerator.generate(e,t,this.scale,this.heatWaves,r),n=0;n<e;n++)for(var s=0;s<t;s++){var h=i[n][s],m=a[n][s],u=o[n][s],l=this.getBiome(h,m,u).getTileSprite(this._mulberry);this.tilemap.setTile(n+r.x,s+r.y,l.i,l.a,!1);}},e.prototype.getBiome=function(e,t,r){for(var i=[],a=this.biomes,o=0;o<a.length;++o){(h=a[o]).matchCondition(e,t,r)&&i.push(new BiomeTempData(h));}var n=0,s=null;for(o=0;o<i.length;++o){var h=i[o];(null==s||h.getDiffValue(e,t,r)<n)&&(s=h.biome,n=h.getDiffValue(e,t,r));}return null==s&&(s=a[0]),s},e}();

	var ChunkLoader=function(){function t(t,e){void 0===e&&(e=15),this._loadedChunks=new Set,this._tempVector2=new Vector2,this.generator=new ProceduralMapGenerator(t),this._chunkSize=e,this._renderer=t;}return t.prototype.vector2ToString=function(t){return t.x+"_"+t.y},t.prototype.generateChunk=function(t){var e=this._chunkSize,o=this._tempVector2.set(t.x*e-Math.floor(e/2),t.y*e-Math.floor(e/2));this.generator.generateMap(e,e,o);},t.prototype.destroyChunk=function(t){for(var e=this._chunkSize,o=this._tempVector2.set(t.x*e-Math.floor(e/2),t.y*e-Math.floor(e/2)),r=this._renderer,n=0;n<e;n++)for(var h=0;h<e;h++)r.deleteTile(o.x+h,o.y+n,!1);},t.prototype.loadChunk=function(t){var e=this.vector2ToString(t);this._loadedChunks.has(e)||(this.generateChunk(t),this._loadedChunks.add(e));},t.prototype.unloadChunk=function(t){var e=this.vector2ToString(t);this._loadedChunks.has(e)&&(this.destroyChunk(t),this._loadedChunks.delete(e));},t.prototype.unloadAllChunks=function(){var t=this;this._loadedChunks.forEach((function(e){var o=e.split("_");t.destroyChunk(new Vector2(parseInt(o[0]),parseInt(o[1])));})),this._loadedChunks.clear();},t.prototype.getChunkIndexFromPosition=function(t,e){return null!=e||(e=new Vector2),e.set(Math.floor((t.x+this._chunkSize/2)/this._chunkSize),Math.floor((t.y+this._chunkSize/2)/this._chunkSize))},t}();

	var __generator=this&&this.__generator||function(e,t){var n,r,o,s,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return u.label++,{value:s[1],done:!1};case 5:u.label++,r=s[1],s=[0];continue;case 7:s=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){u=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){u.label=s[1];break}if(6===s[0]&&u.label<o[1]){u.label=o[1],o=s;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(s);break}o[2]&&u.ops.pop(),u.trys.pop();continue}s=t.call(e,u);}catch(e){s=[6,e],r=0;}finally{n=o=0;}if(5&s[0])throw s[1];return {value:s[0]?s[1]:void 0,done:!0}}([s,i])}}},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return {next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};var UserChunkData=function(){this.loadedChunks=new Set,this.loadChunkQueue=new Set,this.unloadChunkQueue=new Set;},WorldGenerator=function(){function e(e,t,n,r){void 0===n&&(n=15),void 0===r&&(r=3),this._playerChunkPositions=new Map,this._userChunks=new Map,this._loadedChunks=new Map,this._disposed=!1,this._tempVector2=new Vector2,this._taskQueue=new Set,this._runningTasks=new Set,this._tempVector1=new Vector2,this._coroutineDispatcher=e,this._chunkSize=n,this._playerViewDistance=r,this._chunkLoader=new ChunkLoader(t,this._chunkSize),this._loadCirclePoints=this.computeCirclePoints(this._playerViewDistance),this._unloadChunkQueueMaxValue=3*this._loadCirclePoints.length;}return e.prototype.computeCirclePoints=function(e){var t=[];if(e<1)return t;if(1==e)return t.push(new Vector2(0,0)),t;var n=0,r=e-=1,o=3-(e+e);do{for(var s=n,u=-n;u<=s;u++)t.push(new Vector2(u,-r)),t.push(new Vector2(u,r));var i=n;for(u=-n;u<=i;u++)t.push(new Vector2(-r,u)),t.push(new Vector2(r,u));n+=1,o+=o<0?6+(n<<2):10+(n-(r-=1)<<2);}while(n<=r);var a=n-1;for(u=-r;u<=r;u++)for(var h=1-n;h<=a;h++)t.push(new Vector2(h,u));var l=new Set;for(u=0;u<t.length;u++){var c=t[u],d="".concat(c.x,",").concat(c.y);l.has(d)?(t.splice(u,1),u--):l.add(d);}return t.sort((function(e,t){var n=e.length(),r=t.length();return n<r?-1:n>r?1:0})),t},e.prototype.updateChunkEnqueue=function(e,t){var n=this._loadCirclePoints,r=this._userChunks.get(e);void 0===r&&(r=new UserChunkData,this._userChunks.set(e,r));var o=r.loadChunkQueue,s=r.unloadChunkQueue;o.clear(),s.clear();var u=[];Logger.log("loadedChunks ".concat(r.loadedChunks.size)),r.loadedChunks.forEach((function(e){Logger.log("loadedChunk ".concat(e)),u.push(e);}));for(var i=u.length-1;0<=i;--i)s.add(u[i]);if(t)for(i=0;i<n.length;i++){var a=n[i],h=a.x+t.x+"_"+(a.y+t.y);s.has(h)?s.delete(h):o.add(h);}},e.prototype.processUpdateChunk=function(e){var t,n,r,o,s,u,i,a,h,l,c;return __generator(this,(function(d){switch(d.label){case 0:if(void 0===(t=this._userChunks.get(e)))return [2];n=t.loadChunkQueue,r=t.unloadChunkQueue,o=t.loadedChunks,s=Date.now(),d.label=1;case 1:return !(0<n.size||0<r.size)||this._disposed?[3,4]:(this._unloadChunkQueueMaxValue<r.size||n.size<=0?(u=r.keys().next().value,r.delete(u),o.delete(u),void 0!==(h=this._loadedChunks.get(u))&&(h-1<=0?(this._loadedChunks.delete(u),i=u.split("_").map(Number),this._chunkLoader.unloadChunk(this._tempVector2.set(i[0],i[1]))):this._loadedChunks.set(u,h-1))):(a=n.keys().next().value,n.delete(a),o.add(a),void 0===(h=this._loadedChunks.get(a))?(this._loadedChunks.set(a,1),l=a.split("_").map(Number),this._chunkLoader.loadChunk(this._tempVector2.set(l[0],l[1]))):this._loadedChunks.set(a,h+1)),10<(c=Date.now())-s?(s=c,[4,null]):[3,3]);case 2:d.sent(),d.label=3;case 3:return [3,1];case 4:return [2]}}))},e.prototype.lazyUpdateChunk=function(e,t){if(this.updateChunkEnqueue(e,t),!this._runningTasks.has(e)){this._taskQueue.add(e);var n=this;this._runningTasks.size<4&&this._coroutineDispatcher.startCoroutine(function(){return __generator(this,(function(t){switch(t.label){case 0:return n._runningTasks.add(e),[5,__values(n.processUpdateChunk(e))];case 1:return t.sent(),n._runningTasks.delete(e),[2]}}))}());}},e.prototype.updatePlayerPosition=function(e,t){var n=this._chunkLoader.getChunkIndexFromPosition(t,this._tempVector1),r=this._playerChunkPositions.get(e);(null==r?void 0:r.equals(n))||(this.lazyUpdateChunk(e,n),r?r.copy(n):this._playerChunkPositions.set(e,n.clone()));},e.prototype.removePlayer=function(e){this._playerChunkPositions.get(e)&&(this.lazyUpdateChunk(e,void 0),this._playerChunkPositions.delete(e));},e.prototype.dispose=function(){var e=this;this._loadedChunks.forEach((function(t,n){var r=n.split("_").map(Number);e._chunkLoader.unloadChunk(e._tempVector1.set(r[0],r[1]));})),this._disposed=!0;},Object.defineProperty(e.prototype,"generator",{get:function(){return this._chunkLoader.generator},enumerable:!1,configurable:!0}),e}();

	var __extends$2=this&&this.__extends||function(){var r=function(t,o){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,t){r.__proto__=t;}||function(r,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(r[o]=t[o]);},r(t,o)};return function(t,o){if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function e(){this.constructor=t;}r(t,o),t.prototype=null===o?Object.create(o):(e.prototype=o.prototype,new e);}}();var Plugin=function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t._chunkSize=15,t._playerViewDistance=3,t._coroutineDispatcher=null,t._worldGenerator=null,t._players=new Set,t._tempVector=new Vector2,t}return __extends$2(t,r),t.prototype.onLoad=function(){Logger.init(this);try{var r=this._coroutineDispatcher=new CoroutineDispatcher;this._worldGenerator=new WorldGenerator(r,this,this._chunkSize,this._playerViewDistance);}catch(r){Logger.error(r);}},t.prototype.onUnload=function(){try{this._coroutineDispatcher.dispose(),this._coroutineDispatcher=null,this._worldGenerator.dispose(),this._worldGenerator=null;}catch(r){Logger.error(r);}},t.prototype.onPlayerJoin=function(r){var t;try{this._players.add(r),null===(t=this._worldGenerator)||void 0===t||t.updatePlayerPosition(r,this._tempVector.set(0,0));}catch(r){Logger.error(r);}},t.prototype.onPlayerLeave=function(r){var t;try{this._players.delete(r),null===(t=this._worldGenerator)||void 0===t||t.removePlayer(r);}catch(r){Logger.error(r);}},t.prototype.onPlayerMove=function(r,t,o){var e;try{null===(e=this._worldGenerator)||void 0===e||e.updatePlayerPosition(r,this._tempVector.set(t,o));}catch(r){Logger.error(r);}},t}(BasePlugin);globalThis.PluginImpl=Plugin;

}());
