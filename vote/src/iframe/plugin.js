(function () {
	'use strict';

	var Logger=function(){function n(){}return n.init=function(o){n._plugin=o;},n.log=function(o){n._plugin.broadcastMessage("log",o);},n.error=function(o){n._plugin.broadcastMessage("error",o);},n}();

	var __extends=this&&this.__extends||function(){var t=function(e,a){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e;}||function(t,e){for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);},t(e,a)};return function(e,a){if("function"!=typeof a&&null!==a)throw new TypeError("Class extends value "+String(a)+" is not a constructor or null");function n(){this.constructor=e;}t(e,a),e.prototype=null===a?Object.create(a):(n.prototype=a.prototype,new n);}}();var Plugin=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._coroutineDispatcher=null,e._voted_players=new Set,e._vote_count=new Map,e._voting=!1,e._candidates=[],e.data=[],e}return __extends(e,t),e.prototype.onLoad=function(t){var e=this;Logger.init(this),t?(t.votedPlayers.forEach((function(t){return e._voted_players.add(t)})),Object.keys(t.voteCount).forEach((function(a){e._vote_count.set(a,t.voteCount[a]);})),this._voting=t.voting,this._candidates=t.candidates):this.saveData({votedPlayers:[],voteCount:{},voting:!1,candidates:[]}),this._updateData();},e.prototype._saveData=function(){var t=[],e={};this._voted_players.forEach((function(e){return t.push(e)})),this._vote_count.forEach((function(t,a){return e[a]=t})),this.saveData({votedPlayers:t,voteCount:e,voting:this._voting,candidates:this._candidates});},e.prototype.onUnload=function(){try{this._coroutineDispatcher.dispose(),this._coroutineDispatcher=null,this._saveData();}catch(t){Logger.error("".concat(t.message,"\n").concat(t.stack));}},e.prototype._sendState=function(t){this.sendMessage(t,"pstate",this._voting,this._candidates,this.data,this._voted_players.has(t),this.isAdmin(t));},e.prototype._broadCastState=function(){this.broadcastMessage("state",this._voting,this._candidates,this.data);},e.prototype._updateData=function(){var t=this;this.data=this._candidates.map((function(e,a){return [e,t._vote_count.get(a+1)||0]}));},e.prototype.onMessage=function(t,e){for(var a=[],n=2;n<arguments.length;n++)a[n-2]=arguments[n];try{switch(e){case"start":if(!this.isAdmin(t))return;this._voting=!0;break;case"stop":if(!this.isAdmin(t))return;this._voting=!1;break;case"reset":if(!this.isAdmin(t))return;var o=[];this._voted_players.forEach((function(t){return o.push(t)})),this._vote_count.clear(),this._voted_players.clear(),this._candidates=[],this._voting=!1,this._updateData();for(var s=0;s<o.length;s++){var i=o[s];try{this._sendState(i);}catch(t){Logger.error(t);}}break;case"vote":if(this._voted_players.has(t))return;this._voted_players.add(t);var r=a[0];if(!Number.isInteger(r)||!this._voting)return;var c=this._vote_count.get(r);this._vote_count.set(r,(c||0)+1),this._updateData();break;case"add_cand":if(!this.isAdmin(t))return;var h=a[0];this._candidates.push(h),this._updateData();break;case"get_state":this._sendState(t);break;default:Logger.error("unknown event "+e);}this._sendState(t),this._broadCastState(),this._saveData();}catch(t){Logger.error("".concat(t.message,"\n").concat(t.stack));}},e}(BasePlugin);globalThis.PluginImpl=Plugin;

}());
