(function () {
	'use strict';

	var Logger=function(){function n(){}return n.init=function(o){n._plugin=o;},n.log=function(o){n._plugin.broadcastMessage("log",o);},n.error=function(o){n._plugin.broadcastMessage("error",o);},n}();

	var Coroutine=function(){function t(t,e){this._elapsedTime=0,this._coroutineIterator=t,this._currentYieldInstruction=null,this._isCurrenYieldInstructionExist=!1,this._onFinish=null!=e?e:null;}return Object.defineProperty(t.prototype,"elapsedTime",{get:function(){return this._elapsedTime},set:function(t){this._elapsedTime=t;},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentYieldInstruction",{get:function(){return this._currentYieldInstruction},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"currentYieldInstructionExist",{get:function(){return this._isCurrenYieldInstructionExist},enumerable:!1,configurable:!0}),t.prototype.fatchNextInstruction=function(){var t,e=this._coroutineIterator.next();return e.done?(this._currentYieldInstruction=null,this._isCurrenYieldInstructionExist=!1,null===(t=this._onFinish)||void 0===t||t.call(this),this._onFinish=null,null):(this._currentYieldInstruction=e.value,this._isCurrenYieldInstructionExist=!0,this._currentYieldInstruction)},t}();

	var __extends=this&&this.__extends||function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e;}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e;}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r);}}(),YieldInstruction=function(){};var WaitForSeconds=function(t){function e(e){var n=t.call(this)||this;return n._seconds=e,n}return __extends(e,t),Object.defineProperty(e.prototype,"seconds",{get:function(){return this._seconds},enumerable:!1,configurable:!0}),e}(YieldInstruction);var WaitUntil=function(t){function e(e){var n=t.call(this)||this;return n._predicate=e,n}return __extends(e,t),Object.defineProperty(e.prototype,"predicate",{get:function(){return this._predicate},enumerable:!1,configurable:!0}),e}(YieldInstruction);var WaitWhile=function(t){function e(e){var n=t.call(this)||this;return n._predicate=e,n}return __extends(e,t),Object.defineProperty(e.prototype,"predicate",{get:function(){return this._predicate},enumerable:!1,configurable:!0}),e}(YieldInstruction);

	var CoroutineProcessor=function(){function t(t){this._time=t,this._coroutines=[],this._coroutineCount=0;}return t.prototype.addCoroutine=function(t){this._coroutines.push(t),this._coroutineCount+=1;},t.prototype.removeCoroutine=function(t){var o=this._coroutines.indexOf(t);o>=0&&(this._coroutines[o]=null,this._coroutineCount-=1);},t.prototype.tryCompact=function(){var o=this._coroutines;if(t._needToCompactCount<=o.length-this._coroutineCount){for(var n=0,e=0;e<o.length;++e){var i=o[e];null!==i&&(o[n]=i,n+=1);}o.length=this._coroutineCount;}},t.prototype.process=function(){for(var t=this._coroutines,o=0;o<t.length;++o){var n=t[o];null!==n&&(n.currentYieldInstructionExist?this.updateAfterProcessSingleInstruction(n):(t[o]=null,this._coroutineCount-=1));}},t.prototype.updateAfterProcessSingleInstruction=function(t){var o=t.currentYieldInstruction;o instanceof WaitForSeconds?(t.elapsedTime+=this._time.deltaTime,t.elapsedTime>=o.seconds&&(t.elapsedTime=0,t.fatchNextInstruction())):o instanceof WaitUntil?o.predicate()&&t.fatchNextInstruction():o instanceof WaitWhile?o.predicate()||t.fatchNextInstruction():null===o&&t.fatchNextInstruction();},t._needToCompactCount=16,t}();

	var Time=function(){function e(){this._oldTime=0,this._time=0,this._unscaledTime=0,this._deltaTime=0,this._unscaledDeltaTime=0,this._timeScale=1;}return e.prototype.start=function(){this._oldTime=Date.now();},e.prototype.update=function(){var e=Date.now(),t=(e-this._oldTime)/1e3;this._unscaledDeltaTime=t,this._unscaledTime+=t,this._deltaTime=t*this._timeScale,this._time+=this._deltaTime,this._oldTime=e;},Object.defineProperty(e.prototype,"time",{get:function(){return this._time},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"unscaledTime",{get:function(){return this._unscaledTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"deltaTime",{get:function(){return this._deltaTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"unscaledDeltaTime",{get:function(){return this._unscaledDeltaTime},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"timeScale",{get:function(){return this._timeScale},set:function(e){this._timeScale=e;},enumerable:!1,configurable:!0}),e}();

	var CoroutineDispatcher=function(){function o(o){void 0===o&&(o=10);var t=this;this._setTimeoutlId=null,this.update=function(){t._time.update(),t._coroutineProcessor.process(),t._coroutineProcessor.tryCompact();};var e=this._time=new Time;this._coroutineProcessor=new CoroutineProcessor(e),e.start();var r=function(){t._setTimeoutlId=setTimeout((function(){r();}),o);try{t.update();}catch(o){Logger.error("".concat(o.message,"\n").concat(o.stack));}};r();}return o.prototype.startCoroutine=function(o){var t=new Coroutine(o);return t.fatchNextInstruction(),this._coroutineProcessor.addCoroutine(t),t},o.prototype.stopCoroutine=function(o){this._coroutineProcessor.removeCoroutine(o);},o.prototype.dispose=function(){null!==this._setTimeoutlId&&(clearTimeout(this._setTimeoutlId),this._setTimeoutlId=null);},o}();

	var Vector2=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=t,this.y=i;}return t.prototype.freeze=function(){return Object.freeze(this)},t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.set=function(t,i){return this.x=t,this.y=i,this},t.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},t}();

	var __extends$1=this&&this.__extends||function(){var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t;}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);},e(t,i)};return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t;}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n);}}(),__generator=this&&this.__generator||function(e,t){var i,n,o,s,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function l(s){return function(l){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;r;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,n=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(o=r.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=t.call(e,r);}catch(e){s=[6,e],n=0;}finally{i=o=0;}if(5&s[0])throw s[1];return {value:s[0]?s[1]:void 0,done:!0}}([s,l])}}},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return {next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};var TileTask=function(e){this.position=e;},TileAddTask=function(e){function t(t,i,n){var o=e.call(this,t)||this;return o.atlasId=i,o.atlasIndex=n,o}return __extends$1(t,e),t}(TileTask),ColliderTask=function(e,t){this.position=e,this.exists=t;},LazyWorld=function(){function e(e,t){this._spawnedTiles=[],this._spawnedColliders=[],this._tileQueue=[],this._collidersQueue=[],this._coroutine=null,this._dispatcher=e,this._world=t;}return e.prototype.processQueue=function(){var e,t,i,n;return __generator(this,(function(o){switch(o.label){case 0:return [4,null];case 1:o.sent(),e=Date.now(),o.label=2;case 2:return 0<this._tileQueue.length||0<this._collidersQueue.length?(0<this._tileQueue.length?(t=this._tileQueue.shift())instanceof TileAddTask?(this._world.setTile(t.position.x,t.position.y,t.atlasId,t.atlasIndex,!1),this._spawnedTiles.push(t.position)):(this._world.deleteTile(t.position.x,t.position.y,!1),(i=this._spawnedTiles.indexOf(t.position))>=0&&this._spawnedTiles.splice(i,1)):0<this._collidersQueue.length&&(t=this._collidersQueue.shift(),this._world.setCollider(t.position.x,t.position.y,t.exists),t.exists?this._spawnedColliders.push(t.position):(i=this._spawnedColliders.indexOf(t.position))>=0&&this._spawnedColliders.splice(i,1)),10<(n=Date.now())-e?(e=n,[4,null]):[3,4]):[3,5];case 3:o.sent(),o.label=4;case 4:return [3,2];case 5:return [2]}}))},e.prototype.startCoroutineIfNeeded=function(){if(null===this._coroutine){var e=this;this._coroutine=this._dispatcher.startCoroutine(function(){return __generator(this,(function(t){switch(t.label){case 0:return [5,__values(e.processQueue())];case 1:return t.sent(),e._coroutine=null,[2]}}))}());}},e.prototype.setTile=function(e,t,i,n){this._tileQueue.push(new TileAddTask(new Vector2(e,t),i,n)),this.startCoroutineIfNeeded();},e.prototype.deleteTile=function(e,t){this._tileQueue.push(new TileTask(new Vector2(e,t))),this.startCoroutineIfNeeded();},e.prototype.setCollider=function(e,t,i){this._collidersQueue.push(new ColliderTask(new Vector2(e,t),i)),this.startCoroutineIfNeeded();},e.prototype.dispose=function(){for(var e=0;e<this._spawnedTiles.length;++e){var t=this._spawnedTiles[e];this._world.deleteTile(t.x,t.y,!1);}for(e=0;e<this._spawnedColliders.length;++e){t=this._spawnedColliders[e];this._world.setCollider(t.x,t.y,!1);}this._spawnedTiles.length=0,this._spawnedColliders.length=0,null!==this._coroutine&&(this._dispatcher.stopCoroutine(this._coroutine),this._coroutine=null),this._tileQueue.length=0,this._collidersQueue.length=0;},e}();

	var Mulberry32=function(){function t(t){this._a=t;}return t.prototype.next=function(){var t=this._a+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296},t}();

	var GridCell=function(e,r){this.x=e,this.y=r,this.visited=!1,this.walls=[!0,!0,!0,!0];},MazeGenerator=function(){function e(e){this._spawnedTiles=[],this._spawnedColliders=[],this._world=e;}return e.prototype.generate=function(e,r,t,l){for(var s=new Mulberry32(l),o=[],i=0;i<e;++i){o[i]=[];for(var n=0;n<r;++n)o[i][n]=new GridCell(i,n);}var a=[],h=o[0][0];for(h.visited=!0,a.push(h);a.length>0;){var p=a[a.length-1],d=this.getNeighbors(o,p);if(d.length>0){var w=d[Math.floor(s.next()*d.length)];this.removeWalls(p,w),w.visited=!0,a.push(w);}else a.pop();}var f=this.gridCellsToBlocks(o);for(i=0;i<f.length;++i)for(n=0;n<f[0].length;++n){var u=f[i][n],v=i+t.x,y=n+t.y;this._world.setTile(v,y,40,u?1:0),this._spawnedTiles.push(new Vector2(v,y)),u&&(this._world.setCollider(v,y,!0),this._spawnedColliders.push(new Vector2(v,y)));}},e.prototype.clear=function(){for(var e=this._spawnedTiles,r=0;r<e.length;++r){var t=e[r];this._world.deleteTile(t.x,t.y);}e.length=0;var l=this._spawnedColliders;for(r=0;r<l.length;++r){var s=l[r];this._world.setCollider(s.x,s.y,!1);}l.length=0;},e.prototype.getNeighbors=function(e,r){var t,l=[];r.x>0&&((t=e[r.x-1][r.y]).visited||l.push(t));r.x<e.length-1&&((t=e[r.x+1][r.y]).visited||l.push(t));r.y>0&&((t=e[r.x][r.y-1]).visited||l.push(t));r.y<e[0].length-1&&((t=e[r.x][r.y+1]).visited||l.push(t));return l},e.prototype.removeWalls=function(e,r){r.x<e.x?(e.walls[0]=!1,r.walls[1]=!1):r.x>e.x?(e.walls[1]=!1,r.walls[0]=!1):r.y<e.y?(e.walls[2]=!1,r.walls[3]=!1):r.y>e.y&&(e.walls[3]=!1,r.walls[2]=!1);},e.prototype.gridCellsToBlocks=function(e){for(var r=e.length,t=e[0].length,l=new Array(2*r+1).fill(null).map((function(e){return new Array(2*t+1)})),s=0;s<2*r+1;++s)l[s][0]=!0;for(var o=0;o<2*t+1;++o)l[0][o]=!0;for(s=0;s<r;s++)for(o=0;o<t;o++)l[2*s+1][2*o+1]=!1,l[2*s+2][2*o+1]=e[s][o].walls[1],l[2*s+1][2*o+2]=e[s][o].walls[3],l[2*s+2][2*o+2]=!0;for(s=0;s<2*r+1;++s)l[s][2*t]=!0;for(o=0;o<2*t+1;++o)l[2*r][o]=!0;return l},e}();

	var DebounceExecuter=function(){function e(e){void 0===e&&(e=500),this._timer=null,this._delay=e;}return e.prototype.execute=function(e){null!==this._timer&&clearTimeout(this._timer),this._timer=setTimeout(e,this._delay);},e}();

	var __extends$2=this&&this.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t;}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t;}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o);}}();var Plugin=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._coroutineDispatcher=null,t._lazyWorld=null,t._mazeGenerator=null,t._iframePosition=new Vector2(0,0),t._mazePosition=new Vector2(0,0),t._mazeSize=new Vector2(10,10),t._seed=0,t._generateExecuter=new DebounceExecuter(500),t._tempVector=new Vector2,t}return __extends$2(t,e),t.prototype.onLoad=function(e,t){Logger.init(this);try{t.isLocal&&this._iframePosition.set(t.iframe.x,t.iframe.y),this._coroutineDispatcher=new CoroutineDispatcher,this._lazyWorld=new LazyWorld(this._coroutineDispatcher,this),this._mazeGenerator=new MazeGenerator(this._lazyWorld),this.clearAndGenerate();}catch(e){Logger.error("".concat(e.message,"\n").concat(e.stack));}},t.prototype.onUnload=function(){try{this._mazeGenerator.clear(),this._mazeGenerator=null,this._lazyWorld.dispose(),this._lazyWorld=null,this._coroutineDispatcher.dispose(),this._coroutineDispatcher=null;}catch(e){Logger.error("".concat(e.message,"\n").concat(e.stack));}},t.prototype.onMessage=function(e,t){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];try{if("request-position"===t?this.sendMessage(e,"position",this._mazePosition):"request-size"===t?this.sendMessage(e,"size",this._mazeSize):"request-seed"===t&&this.sendMessage(e,"seed",this._seed),"position-input"===t){var n=r[0],i=n.x,a=n.y;this._mazePosition.set(i,a),this.clearAndGenerate();}else if("size-input"===t){var s=r[0];i=s.x,a=s.y;this._mazeSize.set(i,a),this.clearAndGenerate();}else if("seed-input"===t){var c=r[0];this._seed=c,this.clearAndGenerate();}}catch(e){Logger.error("".concat(e.message,"\n").concat(e.stack));}},t.prototype.clearAndGenerate=function(){var e=this;this._generateExecuter.execute((function(){var t,r;null===(t=e._mazeGenerator)||void 0===t||t.clear(),null===(r=e._mazeGenerator)||void 0===r||r.generate(e._mazeSize.x,e._mazeSize.y,e._tempVector.copy(e._mazePosition).add(e._iframePosition),e._seed);}));},t}(BasePlugin);globalThis.PluginImpl=Plugin;

}());
